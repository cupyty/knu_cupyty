; STANDARD HEADER FILE
	PROCESSOR	16F876
;
; BANK 0
INDF	EQU	00H
TMR0	EQU	01H
PCL		EQU	02H
STATUS	EQU	03H
FSR		EQU	04H
PORTA	EQU	05H
PORTB	EQU	06H
PORTC	EQU	07H
EEDATA	EQU	08H
EEADR	EQU	09H
PCLATH	EQU	0AH
INTCON	EQU	0BH
RCSTA	EQU	18H
TXREG	EQU	19H
; BANK 1
OPTIONR	EQU	81H
TRISA	EQU	85H
TRISB	EQU	86H
TRISC	EQU	87H
EECON1	EQU	88H
EECON2	EQU	89H
TXSTA	EQU	98H
SPBRG	EQU	99H
ADCON1	EQU	9FH
;
IRP		EQU	7
RP1		EQU	6
RP0		EQU	5
NOT_TO	EQU	4
NOT_PD	EQU	3
ZF		EQU	2
DC		EQU	1
CF		EQU	0
;
;

W		EQU	B'0'
F		EQU	.1
DBUF1 	EQU 24H ;GPR레지스터에 저장 (중요)
DBUF2 	EQU 25H ;GPR레지스터에 저장 (중요)
DBUF3 	EQU 26H ;GPR레지스터에 저장 (중요)
D_1MIN	EQU 27H
D_10MIN	EQU	28H
INT_CNT	EQU	30H
D_10SEC	EQU	31H
D_1SEC	EQU	32H
MOD_CNT	EQU	33H
W_TEMP	EQU	34H
STATUS_TEMP	EQU	35H
DISP_CNT	EQU	36H
D_1HOUR	EQU	37H
D_10HOUR	EQU	38H
SEC_CNT	EQU	39H

;
ORG		0
GOTO	START_UP
ORG		4
;ISR 시작번지
MOVWF	W_TEMP
SWAPF	STATUS,W
MOVWF	STATUS_TEMP
MOVF	MOD_CNT,W
SUBLW	.1
BTFSS	STATUS,ZF
CALL	DISP
GOTO	RETURN_INT

SEC_VIEW
	BTFSC	SEC_CNT,0
	GOTO	SEC_10
	GOTO	SEC_1
	GOTO	RETURN_INT
SEC_10
	BSF		PORTA,2
	BSF		PORTA,3
	BSF		PORTB,2
	BSF		PORTB,1
	MOVF	D_10SEC,W
	CALL	CONV
	MOVWF	PORTC
	BCF		PORTB,2
	INCF	SEC_CNT
	RETURN
SEC_1
	BSF		PORTA,2
	BSF		PORTA,3
	BSF		PORTB,2
	BSF		PORTB,1
	MOVF	D_1SEC,W
	CALL	CONV
	MOVWF	PORTC
	BCF		PORTB,1
	INCF	SEC_CNT
	INCF	INT_CNT
	RETURN


RETURN_INT
	SWAPF	STATUS_TEMP,W
	MOVWF	STATUS
	SWAPF	W_TEMP,F
	SWAPF	W_TEMP,W
	BCF		INTCON,2
	RETFIE

;DISPLAY ROUTINE
DISP
	BTFSC	DISP_CNT,0
	GOTO	CHECK1
	GOTO	CHECK2
CHECK1
	BTFSC	DISP_CNT,1
	GOTO	DISP1
	GOTO	DISP2
CHECK2
	BTFSC	DISP_CNT,1
	GOTO	DISP3
	GOTO	DISP4
DISP1
	BSF		PORTA,2
	BSF		PORTA,3
	BSF		PORTB,2
	BSF		PORTB,1
	MOVF	D_10MIN,W
	CALL	CONV
	MOVWF	PORTC
	BCF		PORTB,2
	INCF	DISP_CNT
	RETURN
DISP2
	BSF		PORTA,2
	BSF		PORTA,3
	BSF		PORTB,2
	BSF		PORTB,1
	MOVF	D_1MIN,W
	CALL	CONV
	MOVWF	PORTC
	
	BCF		PORTB,1
	INCF	DISP_CNT
	INCF	INT_CNT
	RETURN

DISP3;<10분>
	BSF		PORTA,2
	BSF		PORTA,3
	BSF		PORTB,2
	BSF		PORTB,1
	MOVF	D_1HOUR,W
	CALL	CONV
	MOVWF	PORTC
	;
	MOVLW	.125
	SUBWF	INT_CNT,W
	BTFSC	STATUS,ZF
	CALL	DOT
	;
	MOVLW	.0
	SUBWF	INT_CNT,W
	BTFSC	STATUS,ZF
	CALL	DOT
	;
	BCF		PORTA,3
	INCF	DISP_CNT
	RETURN
DOT
	MOVLW	B'00000001'
	XORWF	PORTC
	RETURN
DISP4;<1분>
	BSF		PORTA,2
	BSF		PORTA,3
	BSF		PORTB,2
	BSF		PORTB,1
	MOVF	D_10HOUR,W
	CALL	CONV
	MOVWF	PORTC
	BCF		PORTA,2
	INCF	DISP_CNT
	INCF	INT_CNT
	RETURN
		

;MAIN PROGRAM
START_UP
	BSF		STATUS,RP0
	MOVLW	B'00000111'
	MOVWF	ADCON1
	MOVLW	B'11110000'
	MOVWF	TRISA
	MOVLW	B'11111000'
	MOVWF	TRISB
	MOVLW	B'00000000'
	MOVWF	TRISC
	MOVLW	B'00000010';2.048msec
	MOVWF	OPTIONR
	BCF		STATUS,RP0
	BSF		INTCON,5;TIMER INTERRUPT ENABLE
	BSF		INTCON,7;GLOBAL INTERRUPT ENABLE
	GOTO	MAIN_ST
	

MAIN_ST;모든 변수 초기화
	CLRF	INT_CNT
	CLRF	D_10SEC
	CLRF	D_1SEC
	CLRF	D_1MIN
	CLRF	D_10MIN
	CLRF	MOD_CNT
	CLRF	D_1HOUR
	CLRF	D_10HOUR
	CLRF	SEC_CNT
	
M_LOOP
	MOVLW	.244
	SUBWF	INT_CNT,W
	BTFSS	STATUS,ZF
	GOTO	XLOOP

CK_LOOP
	CLRF	INT_CNT
	INCF	D_1SEC
	MOVLW	.10
	SUBWF	D_1SEC,W
	BTFSS	STATUS,ZF
	CLRF	D_1SEC
	BTFSC	STATUS,ZF
	INCF	D_10SEC
	MOVF	D_10SEC,W
	SUBLW	.6
	BTFSC	STATUS,ZF
	CLRF	D_10SEC
	BTFSC	STATUS,ZF
	INCF	D_1MIN
	;
	MOVF	D_1MIN,W
	SUBLW	.10
	BTFSC	STATUS,ZF
	CLRF	D_1MIN
	BTFSC	STATUS,ZF
	INCF	D_10MIN
	;
	MOVF	D_10MIN
	SUBLW	.6
	BTFSC	STATUS,ZF
	CLRF	D_10MIN
	BTFSC	STATUS,ZF
	INCF	D_1HOUR
	;
	MOVF	D_1HOUR,W
	SUBLW	.10
	BTFSC	STATUS,ZF
	CLRF	D_1HOUR
	BTFSC	STATUS,ZF
	INCF	D_10HOUR
	;
	MOVF	D_1HOUR,W
	SUBLW	.4
	BTFSC	STATUS,ZF
	CALL	TIMEUP
	GOTO	XLOOP
	
MODE_CHK
	CALL	DELAY
	INCF	MOD_CNT,W_TEMP
	SUBLW	.4
	BTFSC	STATUS,ZF
	CLRF	MOD_CNT
	RETURN
	
TIMEUP
	MOVF	D_10HOUR,W
	ANDLW	0FH
	SUBLW	.2
	BTFSC	STATUS,ZF
	CALL	A_CLR	
	RETURN
	
A_CLR
	MOVLW	.0
	MOVWF	D_1SEC
	MOVWF	D_10SEC
	MOVWF	D_1MIN
	MOVWF	D_10MIN
	MOVWF	D_1HOUR
	MOVWF	D_10HOUR
	RETURN
XLOOP
	GOTO	M_LOOP
	
CONV	
	ANDLW	0FH
	ADDWF	PCL,F
		
	RETLW	B'11111100' ;'0'
	RETLW	B'01100000'	;'1'
	RETLW	B'11011010'	;'2'
	RETLW	B'11110010'	;'3'
	RETLW	B'01100110'	;'4'
	RETLW	B'10110110'	;'5'
	RETLW	B'10111110'	;'6'
	RETLW	B'11100000'	;'7'
	RETLW	B'11111110'	;'8'
	RETLW	B'11110110'	;'9'
	RETLW	B'00010001'
	RETLW	B'11000001'
	RETLW	B'01100011'
	RETLW	B'10000101'
	RETLW	B'01100001'
	RETLW	B'01110001'
	
DELAY
	MOVLW	.40
	MOVWF	DBUF1
LP4	MOVLW	.50
	MOVWF	DBUF2
LP5	NOP
	DECFSZ	DBUF2,F
	GOTO	LP5
	DECFSZ	DBUF1,F	
	GOTO LP4

	BTFSS	PORTB,3
	GOTO 	DELAY
	BTFSS	PORTB,4
	GOTO 	DELAY
	BTFSS	PORTB,5
	GOTO 	DELAY

	RETURN

END

